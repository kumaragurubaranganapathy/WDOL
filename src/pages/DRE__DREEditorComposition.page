<apex:page controller="DRE.DREEditorCompositionController" sidebar="false" id="composition">
    <apex:includeScript value="{!URLFOR($Resource.DRE__jQueryUI, '/external/jquery/jquery.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.DRE__jQueryUI, 'jquery-ui.js')}"/>
    <apex:stylesheet value="{!URLFOR($Resource.DRE__jQueryUI, 'jquery-ui.css')}"/>
    <c:DRELoader loadJQuery="false"/>
    <c:DREStyles enhancedCheckboxes="true"/>
    
    <apex:form id="f">
        <apex:pageBlock id="pb">
            <apex:pageMessages id="msg"/>
            <apex:pageBlockButtons >
                <div class="links" style="width:81px; height:12px; float:left" id="offsetText"/>
                
                <apex:insert name="buttons"/>
                
                <div class="links" style="float:right">
                    <apex:commandLink action="{!openDREEditorSettings}" target="_blank">
                        <span>Customize Editor</span>
                    </apex:commandLink>
                </div>
            </apex:pageBlockButtons>
            
            <apex:insert name="details"/>
            
            <apex:insert name="when"/>
            
            <apex:outputPanel id="groupPanels">
                <apex:insert name="group1"/>
                <apex:insert name="group2"/>
            </apex:outputPanel>
            <apex:pageMessages id="msgBottom"/>
        </apex:pageBlock>
        
        <!-- generic re-render functions -->
        <apex:actionFunction name="refreshGroups" reRender="groupPanels,msg,msgBottom" status="loader"/>
        <apex:actionFunction name="refreshGroup1" reRender="group1Panel" status="loader"/>
        <apex:actionFunction name="refreshGroup2" reRender="group2Panel" status="loader"/>
        <apex:actionFunction name="refreshRelatedLists" reRender="relatedLists" status="loader"/>
    </apex:form>
    
    <apex:outputPanel id="relatedLists">
        <apex:insert name="relatedLists"/>
    </apex:outputPanel>
    
    <!-- Dialogs -->
    <div id="objectPickerDialog" style="display:none" title="Insert Object">
        <apex:outputPanel id="objectPickerPanel">
            <apex:iframe scrolling="true" id="objectPickerFrame"/>
        </apex:outputPanel>
    </div>
    
    <div id="formulaBuilderDialog" style="display:none" title="Enter Formula or Literal Value">
        <apex:outputPanel id="formulaBuilderPanel">
            <apex:iframe scrolling="true" id="formulaBuilderFrame"/>
        </apex:outputPanel>
    </div>
    
    <apex:outputPanel id="scriptPanel">
    <script>
        $(".actionColumn").remove();
        
        $(function()
        {
            $('#objectPickerDialog').hide();
            $('#formulaBuilderDialog').hide();
            
            $('#objectPickerDialog')
                .on('dialogopen', function(event) {
                    $('html, body').css('overflow', 'hidden');
                })
                .on('dialogclose', function(event) {
                    $('#objectPickerFrame').attr('src', '');
                    $('html, body').css('overflow', '');
                });
            $('#formulaBuilderDialog')
                .on('dialogopen', function(event) {
                    $('html, body').css('overflow', 'hidden');
                })
                .on('dialogclose', function(event) {
                    $('#formulaBuilderFrame').attr('src', '');
                    $('html, body').css('overflow', '');
                });
        });
    
        function openObjectPickerDialog(objName, canSelectRoot, canDrillRoot, showAll, showChildren, showGlobal, canSelectLookups, pathId, objId, relId)
        {
            // set frame params for the hidden fields
            objName = objName.replace(/#/g, '%23');
            var frameSrc = '/apex/DRE__DREPicker?objectName=' + objName + '&canSelectRoot=' + canSelectRoot + '&canDrillRoot=' + canDrillRoot + '&showFields=false&showAllObjects=' + showAll + '&showChildren=' + showChildren + '&showGlobal=' + showGlobal + '&canSelectLookups=' + canSelectLookups;
            frameSrc += '&id_path=' + pathId + '&id_object=' + objId + '&id_rel=' + relId;
            $('#objectPickerFrame').attr('src', frameSrc);
            $('#objectPickerDialog').dialog({ modal:true, width:800 });
        }
    
        function openFormulaBuilderDialog(objName, inputId, val, showChildren, showGlobal, showAddFieldButton, showSoql)
        {
            // set frame params for input field
            val = encodeURIComponent(val);
            var frameSrc = '/apex/DRE__DREFormulaBuilder?objectName=' + objName + '&showChildren=' + showChildren + '&showGlobal=' + showGlobal + '&showAddFieldButton=' + showAddFieldButton + '&showSoql=' + showSoql;
            frameSrc += '&id_input=' + inputId + '&value=' + val;
            $('#formulaBuilderFrame').attr('src', frameSrc);
            $('#formulaBuilderDialog').dialog({ modal:true, width:800 });
        }
    
        function closeObjectPickerDialog()
        {
            if ($('#objectPickerDialog').dialog('instance') != undefined && $('#objectPickerDialog').dialog('isOpen'))
                $('#objectPickerDialog').dialog('close');
        }
    
        function closeFormulaBuilderDialog()
        {
            if ($('#formulaBuilderDialog').dialog('instance') != undefined && $('#formulaBuilderDialog').dialog('isOpen'))
                $('#formulaBuilderDialog').dialog('close');
        }
    </script>
    </apex:outputPanel>
</apex:page>