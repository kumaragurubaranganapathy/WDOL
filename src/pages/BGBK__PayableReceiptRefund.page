<apex:page tabStyle="MUSW__Payable_Receipt__c" controller="BGBK.PayableReceiptRefundController" action="{!init}" id="p">
            <apex:includeScript value="/soap/ajax/27.0/connection.js"/>
            <apex:includeScript value="/soap/ajax/27.0/apex.js"/>
            <apex:stylesheet value="/sCSS/29.0/sprites/1297816277000/Theme3/default/gc/versioning.css"/>
            <c:BlockIndicator />            
            <div id="preloader2" style="visibility: hidden;"></div>
            <apex:form id="f">
                <apex:sectionHeader title="{!parentObjectLabel}" subtitle="{!trackno}" id="h">
                    <apex:commandLink action="{!cancel}" value="{!parentObjectLabel}: {!trackno}"/>
                    <apex:pageMessages id="msg"/>
                </apex:sectionHeader>  
                <!-- <apex:pageblock id="pb">
                            <apex:pageblockbuttons id="pbb">
                                <apex:commandbutton value="Quick Save" action="{!savePayableReceiptsAdjustments}" id="saveBtn" reRender="msg,pb" status="saveStatus"/>
                                <apex:commandbutton value="Save" action="{!savePayableReceiptAndReturn}" id="save2RetBtn" reRender="msg" status="saveStatus"/>
                                <apex:commandbutton value="Cancel" action="{!cancel}" id="cancelBtn" immediate="true" status="saveStatus"/>
                            </apex:pageblockbuttons> -->                  
                    
                    <!-- <apex:tabPanel id="tabPanel" switchType="client">
                        <apex:tab label="Adjust Deposit" id="allocsTab"> -->
                        <apex:pageblock id="pbAllocs" rendered="{!actionMode == 'Adjust'}">
                        <apex:pageblockbuttons id="pbb">
                                <apex:commandbutton value="Quick Save" action="{!savePayableReceiptsAdjustments}" id="saveBtn" reRender="msg,pbAllocs" status="saveStatus"/>
                                <apex:commandbutton value="Save" action="{!savePayableReceiptAndReturn}" id="save2RetBtn" reRender="msg" status="saveStatus"/>
                                <apex:commandbutton value="Cancel" action="{!cancel}" id="cancelBtn" immediate="true" status="saveStatus"/>
                            </apex:pageblockbuttons>
                        
		                    <!--------------- PAYMENT ORIENTED VIEW ---------------->
					        <apex:pageBlockTable value="{!relPayReceipts}" var="rvo" rendered="{!relPayReceipts.size > 0}">
					            <apex:repeat value="{!$ObjectType.MUSW__Payable_Receipt__c.FieldSets.BGBK__Payable_Receipt_Basic}" var="field">
					                <apex:column headerValue="{!field.label}">
					                    <apex:inputField value="{!rvo[field]}"/>
					                </apex:column>
					            </apex:repeat>
					        </apex:pageBlockTable>
                            </apex:pageBlock>
                            <apex:actionFunction name="filterPaymentsJS" action="{!loadPayments}" reRender="payments"/>
                
                            <!-- passes error message from javascript webservice callout to controller to show on the page -->
                            <apex:actionFunction name="addErrorJS" action="{!addErrorMessage}" reRender="msg">
                                <apex:param name="errmsg" assignTo="{!errorMessage}" value=""/>
                            </apex:actionFunction>
                            
                            <!-- okToSave is switched on only when Save button is pressed -->
                            <apex:actionFunction name="getGatewayTransactionsJS" action="{!getGatewayTransactions}" reRender="refundProcessScript">
                                <apex:param name="oksave" assignTo="{!okToSave}" value="true"/>
                            </apex:actionFunction>
                            
                        <!-- </apex:tab> -->
                            
                        <!-- <apex:tab label="Refunds" id="refsTab" rendered="{!transactionVersion > 1}" ontabenter="queryReceiptsJS();"> -->
                        <apex:pageblock id="pbRefs" rendered="{!actionMode == 'Refund'}">
                        <apex:pageblockbuttons id="pbb">
                                <apex:commandbutton value="Quick Save" action="{!saveRefundTab}" id="saveBtn" reRender="msg,pbRefs" status="saveStatus"/>
                                <apex:commandbutton value="Save" action="{!saveRefundAndReturn}" id="save2RetBtn" reRender="msg" status="saveStatus"/>
                                <apex:commandbutton value="Cancel" action="{!cancel}" id="cancelBtn" immediate="true" status="saveStatus"/>
                            </apex:pageblockbuttons>
                            <apex:pageblockSection id="refsPanel" columns="1">
                             <apex:pageblockSection title="Available Amount to Refund: ${!totalAvailableAmount}" columns="1" id="refunds" rendered="{!transactionVersion > 1}"  collapsible="false">
                                    <apex:pageBlockTable value="{!existingRefunds}" var="refvo" columns="{!$ObjectType.BGBK__Refund2__c.FieldSets.BGBK__Refund2_Basic.size+3}"  rendered="{!existingRefunds.size > 0}">

                                            <apex:repeat value="{!$ObjectType.BGBK__Refund2__c.FieldSets.BGBK__Refund2_Basic}" var="f" id="refundFsRepeat">
                                              <apex:column value="{!refvo.r2[f]}"/>
                                                </apex:repeat>
                                            </apex:pageBlockTable>
                                        </apex:pageblockSection>
                                <apex:pageblockSection columns="1" id="newRefunds" rendered="{!transactionVersion > 1}">
                                 <apex:pageBlockTable value="{!newRefunds}" var="newrefvo" columns="{!$ObjectType.BGBK__Refund2__c.FieldSets.BGBK__Refund2_Basic.size+3}" width="100%" rendered="{!newRefunds.size > 0}">
                                            <apex:column >
                                                <apex:facet name="header"></apex:facet>
                                                    <apex:commandLink action="{!removeNewCreatedRefund}" value="Remove" reRender="newRefunds" immediate="false">
                                                        <apex:param name="deleterefund" value="{!newrefvo['index']}"/>
                                                    </apex:commandLink>
                                                </apex:column>
                                                <apex:repeat value="{!$ObjectType.BGBK__Refund2__c.FieldSets.BGBK__Refund2_Basic}" var="f" id="newRefFsRepeat">
                                                    <apex:column rendered="{!f != 'BGBK__Contact__c'}">
                                                        <apex:facet name="header">{!$ObjectType.BGBK__Refund2__c.Fields[f].label}</apex:facet>
                                                        <apex:inputField value="{!newrefvo.r2[f]}"/>
                                                    </apex:column>
                                                    <apex:column rendered="{!f = 'BGBK__Contact__c'}">
                                                        <apex:facet name="header">Refundee</apex:facet>
                                                        <apex:selectList value="{!newrefvo.refundee}" label="Refundee" size="1" style="width:150px" id="refundeeList">
                                                            <apex:selectOptions value="{!refundeesRefund}"/>
                                                        </apex:selectList>
                                                        <apex:outputPanel >
                                                            <apex:inputField value="{!newrefvo.tempRefundeeLookup.BGBK__Contact__c}" id="refundee3" style="width:0;color:transparent;background-color:transparent;border:none" onchange="addRefundeeJS(-1, {!newrefvo['index']}, -1, this.value+':'+document.getElementById(this.id+'_lkid').value);"/>
                                                        </apex:outputPanel>
                                                    </apex:column>
                                                </apex:repeat>
                                            </apex:pageBlockTable>
                                            
                                            <apex:commandButton action="{!addRefunds}" value="New Refund" rerender="newRefunds" immediate="false"/>
                                        </apex:pageblockSection>
                                    <apex:actionFunction name="addRefundeeJS" action="{!addRefundees}" reRender="newRefunds,refundeeList" immediate="false">
                                <apex:param name="pmtIndex" assignTo="{!tIndex}" value=""/>
                                <apex:param name="refIndex" assignTo="{!rIndex}" value=""/>
                                <apex:param name="rctIndex" assignTo="{!cIndex}" value=""/>
                                <apex:param name="refName" assignTo="{!customRefundee}" value=""/>
                            </apex:actionFunction>
                            <apex:pageblockSection columns="1" title="Related Receipts" collapsible="false" rendered="{!relReceipts.size > 0}" id="relatedReceipts">
                              <apex:pageBlockTable value="{!relReceipts}" var="receipt">
                              <apex:repeat value="{!$ObjectType.MUSW__Receipt__c.FieldSets.BGBK__Receipt_Adjust}" var="f" id="relReceiptFsRepeat">
                               <apex:column value="{!receipt[f]}"/>
                                </apex:repeat>
                              </apex:pageBlockTable>
                            </apex:pageBlockSection>
                            </apex:pageblockSection>
                        </apex:pageBlock>
                        <!-- </apex:tab>
                        
                    </apex:tabPanel> -->
                        
                    <apex:actionFunction name="queryReceiptsJS" action="{!loadReceipts}"   status="BlockIndicator" oncomplete="document.getElementById('preloader2').style.visibility='hidden';" reRender="pbRefs, pbAllocs"/> 

                    <apex:actionStatus onstart="disableButtons();" onstop="enableButtons();" id="saveStatus"/>
                <!-- </apex:pageBlock> -->
                <style>
                    #preloader2 {
                      margin: 0;
                      margin-top: image-height/2;
                      margin-left: image-width/2;
                      padding: 0;
                      position: absolute;
                      top: 50%;
                      left: 50%;
                      width: 33px;
                      height: 30px;
                      background: #fff url('/img/loading32.gif') no-repeat center center;
                      z-index: 999;
                    }
                  </style>
                <script>
                sforce.connection.sessionId = "{!$Api.Session_ID}";
                function processAndSave() {
                    getGatewayTransactionsJS();
                }
                
                function disableButtons() {
                    document.getElementById("p:f:pbAllocs:pbb:saveBtn").setAttribute("disabled", "disabled");
                    document.getElementById("p:f:pbAllocs:pbb:saveBtn").setAttribute("class", "btnDisabled");
                    document.getElementById("p:f:pbAllocs:pbb:saveBtn").setAttribute("value", "Saving...");
                    document.getElementById("p:f:pbAllocs:pbb:bottom:saveBtn").setAttribute("disabled", "disabled");
                    document.getElementById("p:f:pbAllocs:pbb:bottom:saveBtn").setAttribute("class", "btnDisabled");
                    document.getElementById("p:f:pbAllocs:pbb:bottom:saveBtn").setAttribute("value", "Saving...");
                    document.getElementById("p:f:pbAllocs:pbb:save2RetBtn").setAttribute("disabled", "disabled");
                    document.getElementById("p:f:pbAllocs:pbb:save2RetBtn").setAttribute("class", "btnDisabled");
                    document.getElementById("p:f:pbAllocs:pbb:save2RetBtn").setAttribute("value", "Saving...");
                    document.getElementById("p:f:pbAllocs:pbb:bottom:save2RetBtn").setAttribute("disabled", "disabled");
                    document.getElementById("p:f:pbAllocs:pbb:bottom:save2RetBtn").setAttribute("class", "btnDisabled");
                    document.getElementById("p:f:pbAllocs:pbb:bottom:save2RetBtn").setAttribute("value", "Saving...");
                    document.getElementById("p:f:pbAllocs:pbb:cancelBtn").setAttribute("disabled", "disabled");
                    document.getElementById("p:f:pbAllocs:pbb:cancelBtn").setAttribute("class", "btnDisabled");
                    document.getElementById("p:f:pbAllocs:pbb:cancelBtn").setAttribute("value", "Saving...");
                    document.getElementById("p:f:pbAllocs:pbb:bottom:cancelBtn").setAttribute("disabled", "disabled");
                    document.getElementById("p:f:pbAllocs:pbb:bottom:cancelBtn").setAttribute("class", "btnDisabled");
                    document.getElementById("p:f:pbAllocs:pbb:bottom:cancelBtn").setAttribute("value", "Saving...");
                    document.getElementById("p:f:pbRefs:pbb:saveBtn").setAttribute("disabled", "disabled");
                    document.getElementById("p:f:pbRefs:pbb:saveBtn").setAttribute("class", "btnDisabled");
                    document.getElementById("p:f:pbRefs:pbb:saveBtn").setAttribute("value", "Saving...");
                    document.getElementById("p:f:pbRefs:pbb:bottom:saveBtn").setAttribute("disabled", "disabled");
                    document.getElementById("p:f:pbRefs:pbb:bottom:saveBtn").setAttribute("class", "btnDisabled");
                    document.getElementById("p:f:pbRefs:pbb:bottom:saveBtn").setAttribute("value", "Saving...");
                    document.getElementById("p:f:pbRefs:pbb:save2RetBtn").setAttribute("disabled", "disabled");
                    document.getElementById("p:f:pbRefs:pbb:save2RetBtn").setAttribute("class", "btnDisabled");
                    document.getElementById("p:f:pbRefs:pbb:save2RetBtn").setAttribute("value", "Saving...");
                    document.getElementById("p:f:pbRefs:pbb:bottom:save2RetBtn").setAttribute("disabled", "disabled");
                    document.getElementById("p:f:pbRefs:pbb:bottom:save2RetBtn").setAttribute("class", "btnDisabled");
                    document.getElementById("p:f:pbRefs:pbb:bottom:save2RetBtn").setAttribute("value", "Saving...");
                    document.getElementById("p:f:pbRefs:pbb:cancelBtn").setAttribute("disabled", "disabled");
                    document.getElementById("p:f:pbRefs:pbb:cancelBtn").setAttribute("class", "btnDisabled");
                    document.getElementById("p:f:pbRefs:pbb:cancelBtn").setAttribute("value", "Saving...");
                    document.getElementById("p:f:pbRefs:pbb:bottom:cancelBtn").setAttribute("disabled", "disabled");
                    document.getElementById("p:f:pbRefs:pbb:bottom:cancelBtn").setAttribute("class", "btnDisabled");
                    document.getElementById("p:f:pbRefs:pbb:bottom:cancelBtn").setAttribute("value", "Saving...");
                }
                
                function enableButtons() {
                    document.getElementById("p:f:pbAllocs:pbb:saveBtn").removeAttribute("disabled");
                    document.getElementById("p:f:pbAllocs:pbb:saveBtn").setAttribute("class", "btn");
                    document.getElementById("p:f:pbAllocs:pbb:saveBtn").setAttribute("value", "Quick Save");
                    document.getElementById("p:f:pbAllocs:pbb:bottom:saveBtn").removeAttribute("disabled");
                    document.getElementById("p:f:pbAllocs:pbb:bottom:saveBtn").setAttribute("class", "btn");
                    document.getElementById("p:f:pbAllocs:pbb:bottom:saveBtn").setAttribute("value", "Quick Save");
                    document.getElementById("p:f:pbAllocs:pbb:save2RetBtn").removeAttribute("disabled");
                    document.getElementById("p:f:pbAllocs:pbb:save2RetBtn").setAttribute("class", "btn");
                    document.getElementById("p:f:pbAllocs:pbb:save2RetBtn").setAttribute("value", "Save");
                    document.getElementById("p:f:pbAllocs:pbb:bottom:save2RetBtn").removeAttribute("disabled");
                    document.getElementById("p:f:pbAllocs:pbb:bottom:save2RetBtn").setAttribute("class", "btn");
                    document.getElementById("p:f:pbAllocs:pbb:bottom:save2RetBtn").setAttribute("value", "Save");
                    document.getElementById("p:f:pbAllocs:pbb:cancelBtn").removeAttribute("disabled");
                    document.getElementById("p:f:pbAllocs:pbb:cancelBtn").setAttribute("class", "btn");
                    document.getElementById("p:f:pbAllocs:pbb:cancelBtn").setAttribute("value", "Cancel");
                    document.getElementById("p:f:pbRefs:pbb:bottom:cancelBtn").removeAttribute("disabled");
                    document.getElementById("p:f:pbRefs:pbb:bottom:cancelBtn").setAttribute("class", "btn");
                    document.getElementById("p:f:pbRefs:pbb:bottom:cancelBtn").setAttribute("value", "Cancel");
                    document.getElementById("p:f:pbRefs:pbb:saveBtn").removeAttribute("disabled");
                    document.getElementById("p:f:pbRefs:pbb:saveBtn").setAttribute("class", "btn");
                    document.getElementById("p:f:pbRefs:pbb:saveBtn").setAttribute("value", "Quick Save");
                    document.getElementById("p:f:pbRefs:pbb:bottom:saveBtn").removeAttribute("disabled");
                    document.getElementById("p:f:pbRefs:pbb:bottom:saveBtn").setAttribute("class", "btn");
                    document.getElementById("p:f:pbRefs:pbb:bottom:saveBtn").setAttribute("value", "Quick Save");
                    document.getElementById("p:f:pbRefs:pbb:save2RetBtn").removeAttribute("disabled");
                    document.getElementById("p:f:pbRefs:pbb:save2RetBtn").setAttribute("class", "btn");
                    document.getElementById("p:f:pbRefs:pbb:save2RetBtn").setAttribute("value", "Save");
                    document.getElementById("p:f:pbRefs:pbb:bottom:save2RetBtn").removeAttribute("disabled");
                    document.getElementById("p:f:pbRefs:pbb:bottom:save2RetBtn").setAttribute("class", "btn");
                    document.getElementById("p:f:pbRefs:pbb:bottom:save2RetBtn").setAttribute("value", "Save");
                    document.getElementById("p:f:pbRefs:pbb:cancelBtn").removeAttribute("disabled");
                    document.getElementById("p:f:pbRefs:pbb:cancelBtn").setAttribute("class", "btn");
                    document.getElementById("p:f:pbRefs:pbb:cancelBtn").setAttribute("value", "Cancel");
                    document.getElementById("p:f:pbRefs:pbb:bottom:cancelBtn").removeAttribute("disabled");
                    document.getElementById("p:f:pbRefs:pbb:bottom:cancelBtn").setAttribute("class", "btn");
                    document.getElementById("p:f:pbRefs:pbb:bottom:cancelBtn").setAttribute("value", "Cancel");
                }
                </script>
                
                <!-- Render this area after gatewayTransactions is populated by the actionFunction. Like a callback. -->
                <apex:outputPanel id="refundProcessScript">
                    <apex:outputPanel rendered="{!okToSave}">
                        <script>
                        var trans = "{!gatewayTransactions}";
                        if (trans != "{}") {
                            trans = trans.replace("{", "").replace("}", "");
                            var transArr = trans.split(", ");
                            
                            for (var i=0; i<transArr.length; i++) {
                                var aid = transArr[i].split("=")[0].split(":")[0];
                                var tid = transArr[i].split("=")[0].split(":")[1];
                                var amt = parseFloat(transArr[i].split("=")[1]);
                                
                                var allSuccess = true;
                                try {
                                    var resp = sforce.apex.execute("PaymentGateway", "refund", {accountId:aid, transactionId:tid, amount:amt});
                                } catch (err) {
                                    addErrorJS(err.faultstring);
                                    allSuccess = false;
                                    break;
                                }
                            }
                            
                            if (allSuccess == true) saveJS();
                        }
                        else {
                            saveJS();
                        }
                        </script>
                    </apex:outputPanel>
                </apex:outputPanel>
            </apex:form>
</apex:page>