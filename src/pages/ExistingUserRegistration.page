<apex:page controller="ExistingUserRegistration_CC"
           standardStylesheets="false" sidebar="false" showHeader="false"
           docType="html-5.0" cache="true" applyHtmlTag="true" applyBodyTag="false" >
    <html xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">

        <head>
            <title>Existing User Registration</title>
            <link rel="shortcut icon" href="{!URLFOR($Resource.favicon)}" type="image/x-icon" />
            <c:Resources />
            <c:PasswordJSUtility />
            <apex:stylesheet value="{!URLFOR($Resource.DDStyle,'bootstrap-select/bootstrap-select.min.css')}" />
            <apex:includeScript value="{!URLFOR($Resource.DDStyle,'bootstrap-select/bootstrap-select.min.js')}" />
            <apex:includeScript value="{!$Resource.Mask}"/>
         </head>

        <body class="internal">
            <c:Header rendered="{!NOT(isGuestUser)}"/>
            <c:HeaderUnauthUser rendered="{!isGuestUser}"/>  
        <main>

            <div class="container headerMain">
                <div id="internal-header">
                    <h1> Existing User Registration </h1>
                </div>
             </div>


            <section class="below-the-fold">
            <div class="container">

                <apex:outputpanel rendered="{!NOT(isPageConfValid)}">
                    {ResultObject.message}
                </apex:outputpanel>

                <apex:form styleClass="animated-form" id="exlicenseform" rendered="{!isPageConfValid}">

                    <div class="col-sm-4">
                            <p class="p-padding">
                                Register here for a new dsps.Wisconsin.Gov account associated with your existing Wisconsin professional Credentials. In the event you do not have the required security code, click the ‘Obtain Security Code’ button.
                            </p>
                            <p>
                                Your social security number is required for accurate identification.
                            </p>
                          <!--  <p>
                            <a target="_blank" href="{!$Label.Str_RegistrationInstructionsLink}">Need help registering? Click here</a>
                            </p> -->
                        </div>
                        <div class="col-sm-8">
                            <div class="row">
                                <!-- <span id="topMessagePanel"></span> -->
                                <div class="col-sm-12 individual-show animated-form-custom">
                                    
                                        
                                        <div class="row">
                                            <div class="col-sm-6" id="ssn_col">
                                                    <div class="animated-input-group  requiredElement">
                                                        <apex:outputLabel value="Social Security Number" for="ssn" styleClass="InputLabel"/>
                                                        <apex:inputText id="ssn" maxlength="11" value="{!ssnForPage}" styleClass="form-control" html-aria-required="true"/>
                                                        <span class="bottomShade"></span>
                                                    </div>
                                                </div>
    
                                                <div class="col-sm-6" id="no_ssn_col" style="display:none;">
                                                    <div class="animated-input-group requiredElement">
                                                        <apex:outputLabel for="reason" value="Reason for not provding SSN" styleClass="InputLabel"/>
                                                        <apex:inputField id="reason" value="{!newCon.Reason_for_No_SSN__c}" styleClass="form-control"/>
                                                        <span class="bottomShade"></span>
                                                    </div>
                                                </div>
    
                                               <div class="col-sm-6">
                                                  <div class="animated-input-group">
                                                        <input id="noSSNcheckbox" type="checkbox" value=""/>
                                                        <label for="noSSNcheckbox"> I don't have a Social Security Number</label>
                                                  </div>
                                              </div>
                                              
                                              <div class="col-sm-12" id="no_ssn_warning" style="display:none;">
                                                <p class="warningText">
                                                    NOTICE - You have indicated that you do not have a Social Security Number. Federal and state child support enforcement law requires collection of social security numbers as part of the application and renewal process. By selecting this option you acknowledge you will need to contact DSPS to have this information added.
                                                </p>
                                              </div>
                                        
                                        
                                        </div>
                                        

                                        
                                        <div class="row">
                                            <div class="col-sm-6">
                                                <div class="animated-input-group requiredElement">
                                                    <apex:outputLabel for="seccode" value="Security Code" styleClass="InputLabel"/>
                                                    <apex:inputText id="seccode" maxlength="10" value="{!newCon.Security_Code__c}" styleClass="form-control" html-aria-required="true" />
                                                    <span class="bottomShade"></span>
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                                <div class="animated-input-group">
                                                <input type="button" class="btn btn-primary" value="Obtain Security Code" onclick="USER_REG.obtainSecCode();"/>
                                                </div>
                                            </div>
                                       </div>

                                        <div class="row">
                                           <div class="col-sm-6">
                                                <div class="animated-input-group requiredElement">
                                                    <label for="bday" class="InputLabel"> Date of Birth <span class="hiddenText">(MM/DD/YYYY)</span></label>
                                                    <input type="text" name="birthDate" class="form-control customDateNow" id="bday" aria-required="true"/>  
                                                    <span class="bottomShade"></span> 
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-sm-6">
                                                <div class="animated-input-group requiredElement">
                                                    <apex:outputLabel for="email" value="Email" styleClass="InputLabel"/>
                                                    <apex:inputField value="{!newCon.Email}" styleClass="form-control" id="email" html-aria-required="true"/>
                                                    <span class="bottomShade"></span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-sm-6">
                                                <div class="animated-input-group requiredElement">
                                                    <apex:outputLabel for="password" value="Password" styleClass="InputLabel"/>
                                                    <apex:inputSecret id="password" styleClass="form-control" html-aria-required="true" />
                                                    <span class="bottomShade"></span>
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                                <div class="animated-input-group requiredElement">
                                                    <apex:outputLabel for="confirmPassword" value="Confirm Password" styleClass="InputLabel"/>
                                                    <apex:inputSecret id="confirmPassword"  styleClass="form-control" html-aria-required="true"/>
                                                    <span class="bottomShade"></span>
                                                </div>
                                            </div>
                                    </div>
                                    <div class="row" id="passwordStrengthPlaceHolder"></div>
                                    
                                    <div class="row top-padding">
                                        <input type="button" class="btn btn-primary" value="Submit" onclick="USER_REG.submitForm();"/>
                                    </div>
                                    
                                </div>
                             </div>
                        </div>

                 <apex:actionStatus id="actionStatusNewReg"
                 onstart="NOTIFICATIONS.spinnerStart();"
                 onstop="NOTIFICATIONS.spinnerStop();USER_REG.processRegResult();"/>

                 <apex:ActionFunction immediate="false"
                     name="RegisterExistingUser"
                     namespace="USERAF"
                     action="{!registerExistingWithCode}"
                     rerender="resultPanel"
                     status="actionStatusNewReg">
                         <apex:param name="userPassword" value="" assignTo="{!passwordParameter}"/>
                         <apex:param name="birthDate" value="" assignTo="{!birthDate}"/>
                     </apex:ActionFunction>

                 </apex:form>
                
                 <apex:outputpanel id="resultPanel" style="display:none;" layout="block">
                    {!ResultData}
                 </apex:outputpanel>

                 </div>
            </section>
        </main>
      </body>
        <c:Footer />


    <script type="text/javascript">

        ;USER_REG =
        {
            
            obtainSecCode : function()
            {
                NOTIFICATIONS.spinnerStart();
                window.location = '/ForgotSecurityCode' ;
            },
            
            submitForm : function()
            {
                // IF ssn is optional , then alter validator object
                if($("#noSSNcheckbox").prop("checked") == true )
                {
                    global_validator = USER_REG.bindValidations($(".animated-form-custom"),'no_ssn') ;
                }
    
                //Perform validation with callback
    
                global_validator.performValidation();
            },
            
            showSSNConfirmation : function()
        {
            if($("[id$='ssn']").val() != '' && $("[id$='ssn']").val().length > 9)
            {
                var  modalContent = $("<div>").addClass("row");
                modalContent.append($("<p>").append
                (
                    $("<span>").html("Please verify the Social Security Number entered " ),
                    $("<span>").html($("[id$='ssn']").val()).addClass('ssn_bold'),
                    $("<span>").html(". "),
                    $("<span>").html("If this is correct hit 'Confirm' to complete your registration, otherwise hit 'Edit' to make a change.")
                ));
                
                
                modalContent.append
                (
                    $("<div>").addClass("row center-aligned").append
                    (
                    
                        $("<input>").attr("type","button").addClass("btn btn-primary spaced").val("Edit")
                        .on("click",function(e)
                        {
                            bootbox.hideAll();  
                        }),
                        
                        
                        $("<input>").attr("type","button").addClass("btn btn-secondary spaced").val("Confirm")
                        .on("click",function(e)
                        {
                            USERAF.RegisterExistingUser($("input[id$='confirmPassword']").val() , $("#bday").val());
                            bootbox.hideAll();  
                        })
                    )
                );
                
                MODAL_UTILITY.openModalWithOptions(modalContent , 'SSN Confirmation');
            }else
            {
                USERAF.RegisterExistingUser($("input[id$='confirmPassword']").val() , $("#bday").val());
            }
        },
            
            processRegResult : function()
            {
                var resultString = $("div[id$='resultPanel']").html();

                if(resultString.length > 3 )
                {
                    var result = JSON.parse(resultString);
                    
                    
                    if(result.isSuccess == false )
                    {
                        var errorMessage = $("<ul>") ;
                        $(result.displayMessages).each(function(index,val){
                            errorMessage.append(
                                $("<li>").html(val)
                            );
                        });
                        MODAL_UTILITY.errorMessageModal(errorMessage , 'Error(s) in Existing User Registration ');
                    }
                }
            },

            bindValidations : function(contForm , valType)
            {
                
                var ssnField = null ;
                   
                if(typeof valType =="undefined")
                    {
                        ssnField = 
                            {
                               id: "ssn",
                               watch: true,
                               name : "SSN",
                               required : true, 
                               validator:"SSN"
                            } 
                        
                    }else if(valType =='no_ssn')
                    {
                            ssnField =
                            {
                               id: "reason",
                               watch: true,
                               name : "Reason for No SSN ",
                               required : true
                            }
                    }
                
                var fieldsList =
                [
                     
                     ssnField,
                     {
                       id: "seccode",
                       watch: true,
                       name : "Security Code",
                       required : true
                     },
                     {
                       id: "bday",
                       watch: true,
                       name : "Date of Birth",
                       required : true,
                       event : 'keyup keydown blur',
                       validator:"Date"
                     },
                     {
                       id: "email",
                       watch: true,
                       name : "Email",
                       validator : "Email",
                       required : true
                     },
                 {
                       id: "password",
                       watch: true,
                       name : "Password",
                       required : true,
                   event : 'keyup keydown blur',
                   customValidator : function(validator){
                     validator.isValid = passwordManager.isValidCritera(validator.element.val())
                     validator.isValid
                      ? validator.error = null
                      : validator.error = validator.name + " is not upto specification"
                   }
                      },
                      {
                       id: "confirmPassword",
                       watch: true,
                       name : "Confirm Password",
                       required : true,
                   event : 'blur',
                   customValidator : function(validator){
                    if(validator.element.val() == validator.engineScope._validatorsMap["password"].element.val()){
                        validator.isValid = true;
                        validator.error = null;
                      } else {
                        validator.isValid = false;
                        validator.error = "Password not matching"
                      }
                   }
                     }
                   ] ;

                var fieldObject = {
                    onValidationSuccess : function()
                    {
                        USER_REG.showSSNConfirmation();
                    },

                    form: contForm ,

                    defaultStyle: function (element, isValid) {
                        element.closest(".animated-input-group").find("span.errorHidden").remove();
                        isValid
                        ? element.closest(".animated-input-group").removeClass("errorElement").find("span.errorHidden").remove()
                        : element.closest(".animated-input-group").addClass("errorElement").find("label").prepend("<span class='errorHidden'>error</span>");
                    },

                    fields: fieldsList
                } ;

                return new ValidationEngine(fieldObject);

            }
        }


        $( document ).ready(function()
        {

            NOTIFICATIONS.spinnerStart();

        passwordManager = new PasswordManager({
              container: $("#passwordStrengthPlaceHolder"),
            customTestCases : [{
                    caseName : 'firstLast',
                    type : 'custom',
                    field : 'firstlast',
                    customTestCase : function(isValid, password){
                      var testString = password.toLowerCase();
                    var hasFirst = null;
                    var hasLast = null;
                        /*$("[id$='lastName']").val().toLowerCase() == ""
                       ? hasLast = false
                       : hasLast = testString.indexOf($("[id$='lastName']").val().toLowerCase()) > -1
                    $("[id$='firstName']").val().toLowerCase() == ""
                      ? hasFirst = false
                      : hasFirst = testString.indexOf($("[id$='firstName']").val().toLowerCase()) > -1
                      */
                    return !hasFirst && !hasLast;
                    }
                  }
              ]
            });


            $(".animated-form-custom").bindAnimatedForm();
            
            
            $('[id$="ssn"]').mask('000-00-0000');
            
            $("#noSSNcheckbox").on("click",function(e)
            {
                    if($(this).prop("checked"))
                    {
                        $("#ssn_col").hide();
                        $("#ssn_col").find("input").val('') ;
                        $("#no_ssn_col").show();
                        $("#no_ssn_warning").show();
                    }else
                    {
                        $("#no_ssn_col").hide();
                        $("#no_ssn_warning").hide();
                        $("#ssn_col").show();
                    }
             });
            
            
            global_validator = USER_REG.bindValidations($(".animated-form-custom"));
            USER_REG.processRegResult() ;

            NOTIFICATIONS.spinnerStop();
        });

        var global_validator = null ;
        var passwordManager = null ;
    </script>
    
    <style type="text/css">
        .ssn_bold
        {
        font-size: 15px;
        font-weight: bold ;
        }
        .center-aligned{text-align:center;}
        .spaced{
            margin-left:10px;
        }
     </style>


    </html>
</apex:page>